// app.js - Express.js + MongoDB + RabbitMQ Entegrasyonu (D√ºzenlenmi≈ü)
require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const amqp = require('amqplib');

const app = express();

// RabbitMQ deƒüi≈ükenleri
let channel = null;
let connection = null;

// RabbitMQ baƒülantƒ± ve kuyruk y√∂netimi
const QUEUES = [
    'email-queue',
    'sms-queue',
    'analytics-queue',
    'image-processing-queue'
];

async function connectRabbitMQ() {
    try {
        connection = await amqp.connect(process.env.RABBITMQ_URL, { heartbeat: 10 });
        channel = await connection.createChannel();

        // Kuyruklarƒ± olu≈ütur
        for (const queue of QUEUES) {
            await channel.assertQueue(queue, { durable: true });
        }

        console.log('‚úÖ RabbitMQ\'ya ba≈üarƒ±yla baƒülandƒ±!');
        console.log('üì¨ Kuyruklar olu≈üturuldu:', QUEUES.join(', '));

        // Baƒülantƒ± kapanƒ±rsa tekrar baƒülanmayƒ± dene
        connection.on('close', () => {
            console.error('‚ùå RabbitMQ baƒülantƒ±sƒ± kapandƒ±. Yeniden baƒülanƒ±lƒ±yor...');
            channel = null;
            setTimeout(connectRabbitMQ, 5000);
        });

        connection.on('error', (err) => {
            console.error('‚ùå RabbitMQ baƒülantƒ± hatasƒ±:', err.message);
        });
    } catch (error) {
        console.error('‚ùå RabbitMQ baƒülantƒ± hatasƒ±:', error.message);
        channel = null;
        setTimeout(connectRabbitMQ, 5000);
    }
}

connectRabbitMQ();

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// CORS
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    if (req.method === 'OPTIONS') {
        res.sendStatus(200);
    } else {
        next();
    }
});

// Logging
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    next();
});

// MongoDB Baƒülantƒ±sƒ±
mongoose.connect(process.env.MONGODB_URI)
    .then(() => {
        console.log('‚úÖ MongoDB\'ye ba≈üarƒ±yla baƒülandƒ±!');
        console.log('üìç Database:', mongoose.connection.name);
    })
    .catch((error) => {
        console.error('‚ùå MongoDB baƒülantƒ± hatasƒ±:', error.message);
        process.exit(1);
    });

// Mongoose Schema ve Model
const userSchema = new mongoose.Schema({
    name: {
        type: String,
        required: [true, 'ƒ∞sim zorunludur'],
        trim: true,
        minlength: [2, 'ƒ∞sim en az 2 karakter olmalƒ±dƒ±r'],
        maxlength: [50, 'ƒ∞sim en fazla 50 karakter olabilir']
    },
    email: {
        type: String,
        required: [true, 'Email zorunludur'],
        unique: true,
        lowercase: true,
        trim: true,
        match: [/^[^\s@]+@[^\s@]+\.[^\s@]+$/, 'Ge√ßerli bir email adresi giriniz']
    },
    phone: {
        type: String,
        trim: true
    },
    age: {
        type: Number,
        required: [true, 'Ya≈ü zorunludur'],
        min: [0, 'Ya≈ü 0\'dan k√º√ß√ºk olamaz'],
        max: [120, 'Ya≈ü 120\'den b√ºy√ºk olamaz']
    },
    status: {
        type: String,
        enum: ['active', 'inactive', 'pending'],
        default: 'active'
    },
    createdAt: {
        type: Date,
        default: Date.now
    },
    updatedAt: {
        type: Date,
        default: Date.now
    }
});

userSchema.pre('save', function(next) {
    this.updatedAt = Date.now();
    next();
});

const User = mongoose.model('User', userSchema);

// Routes

app.get('/', (req, res) => {
    res.json({
        message: 'üöÄ Express.js + MongoDB + RabbitMQ API\'sine Ho≈ü Geldiniz!',
        version: '3.0.0',
        database: 'MongoDB + Mongoose',
        queue: 'RabbitMQ',
        endpoints: {
            'GET /api/users': 'T√ºm kullanƒ±cƒ±larƒ± listele',
            'GET /api/users/:id': 'Belirli bir kullanƒ±cƒ±yƒ± getir',
            'POST /api/users': 'Yeni kullanƒ±cƒ± olu≈ütur',
            'PUT /api/users/:id': 'Kullanƒ±cƒ± bilgilerini g√ºncelle',
            'DELETE /api/users/:id': 'Kullanƒ±cƒ±yƒ± sil',
            'GET /api/users/stats/summary': 'Kullanƒ±cƒ± istatistikleri'
        },
        services: {
            mongodb: mongoose.connection.readyState === 1 ? 'Connected' : 'Disconnected',
            rabbitmq: channel ? 'Connected' : 'Disconnected'
        }
    });
});

// GET /api/users
app.get('/api/users', async (req, res) => {
    try {
        const { name, minAge, maxAge, status, limit = 10, page = 1, sort = 'createdAt' } = req.query;

        let query = {};

        if (name) {
            query.name = { $regex: name, $options: 'i' };
        }

        if (minAge || maxAge) {
            query.age = {};
            if (minAge) query.age.$gte = parseInt(minAge);
            if (maxAge) query.age.$lte = parseInt(maxAge);
        }

        if (status) {
            query.status = status;
        }

        const pageNum = parseInt(page);
        const limitNum = parseInt(limit);
        const skip = (pageNum - 1) * limitNum;

        const total = await User.countDocuments(query);

        const users = await User.find(query)
            .sort(sort)
            .skip(skip)
            .limit(limitNum)
            .select('-__v');

        res.json({
            success: true,
            count: users.length,
            total: total,
            page: pageNum,
            totalPages: Math.ceil(total / limitNum),
            data: users
        });

    } catch (error) {
        res.status(500).json({
            success: false,
            message: 'Kullanƒ±cƒ±lar getirilirken hata olu≈ütu',
            error: error.message
        });
    }
});

// GET /api/users/:id
app.get('/api/users/:id', async (req, res) => {
    try {
        const user = await User.findById(req.params.id).select('-__v');

        if (!user) {
            return res.status(404).json({
                success: false,
                message: 'Kullanƒ±cƒ± bulunamadƒ±'
            });
        }

        res.json({
            success: true,
            data: user
        });

    } catch (error) {
        if (error.name === 'CastError') {
            return res.status(400).json({
                success: false,
                message: 'Ge√ßersiz kullanƒ±cƒ± ID formatƒ±'
            });
        }

        res.status(500).json({
            success: false,
            message: 'Kullanƒ±cƒ± getirilirken hata olu≈ütu',
            error: error.message
        });
    }
});

// POST /api/users - RabbitMQ Entegrasyonlu
app.post('/api/users', async (req, res) => {
    try {
        const { name, email, age, status, phone } = req.body;

        const newUser = new User({
            name,
            email,
            phone,
            age,
            status: status || 'active'
        });

        const savedUser = await newUser.save();

        // RabbitMQ mesajlarƒ±nƒ± g√∂nder
        if (channel) {
            try {
                // 1. Analytics Queue
                channel.sendToQueue(
                    'analytics-queue',
                    Buffer.from(JSON.stringify({
                        action: 'analytics-user-registered',
                        userId: savedUser._id,
                        data: {
                            event: 'user-registered',
                            data: {
                                userAge: savedUser.age,
                                registrationDate: savedUser.createdAt,
                                source: 'api'
                            }
                        }
                    })),
                    { persistent: true }
                );

                // 2. Email Queue
                channel.sendToQueue(
                    'email-queue',
                    Buffer.from(JSON.stringify({
                        action: 'email-welcome',
                        userId: savedUser._id,
                        data: {
                            email: savedUser.email,
                            type: 'welcome',
                            data: {
                                userName: savedUser.name
                            }
                        }
                    })),
                    { persistent: true }
                );

                // 3. SMS Queue
                if (phone) {
                    const verificationCode = Math.floor(100000 + Math.random() * 900000);
                    channel.sendToQueue(
                        'sms-queue',
                        Buffer.from(JSON.stringify({
                            action: 'sms-verification',
                            data: {
                                phone: phone,
                                content: `Merhaba ${savedUser.name}, hesabƒ±nƒ±z olu≈üturuldu! Doƒürulama kodu: ${verificationCode}`,
                                type: 'verification'
                            }
                        })),
                        { persistent: true }
                    );
                }

                // 4. Image Processing Queue
                channel.sendToQueue(
                    'image-processing-queue',
                    Buffer.from(JSON.stringify({
                        action: 'image-processed',
                        userId: savedUser._id,
                        data: {
                            imagePath: '/uploads/default-avatar.jpg',
                            operations: ['resize', 'optimize', 'thumbnail']
                        }
                    })),
                    { persistent: true }
                );

                console.log(`üì§ Mesajlar kuyruƒüa g√∂nderildi: ${savedUser.email}`);
            } catch (queueError) {
                console.error('‚ö†Ô∏è RabbitMQ mesaj g√∂nderme hatasƒ±:', queueError.message);
            }
        } else {
            console.warn('‚ö†Ô∏è RabbitMQ baƒülantƒ±sƒ± yok, mesajlar kuyruƒüa g√∂nderilemedi.');
        }

        res.status(201).json({
            success: true,
            message: 'Kullanƒ±cƒ± olu≈üturuldu! Background i≈ülemleri ba≈ülatƒ±ldƒ±.',
            data: savedUser,
            backgroundJobs: {
                email: 'Welcome email g√∂nderiliyor...',
                sms: phone ? `SMS g√∂nderiliyor: ${phone}...` : 'Telefon numarasƒ± yok',
                analytics: 'User registration analytics kaydediliyor...',
                imageProcessing: 'Profil resmi i≈üleniyor...'
            }
        });

    } catch (error) {
        if (error.name === 'ValidationError') {
            const validationErrors = Object.values(error.errors).map(err => err.message);
            return res.status(400).json({
                success: false,
                message: 'Validation hatasƒ±',
                errors: validationErrors
            });
        }

        if (error.code === 11000) {
            return res.status(409).json({
                success: false,
                message: 'Bu email adresi zaten kullanƒ±lƒ±yor'
            });
        }

        res.status(500).json({
            success: false,
            message: 'Kullanƒ±cƒ± olu≈üturulurken hata olu≈ütu',
            error: error.message
        });
    }
});

// PUT /api/users/:id
app.put('/api/users/:id', async (req, res) => {
    try {
        const { name, email, age, status, phone } = req.body;

        const updatedUser = await User.findByIdAndUpdate(
            req.params.id,
            { name, email, phone, age, status, updatedAt: Date.now() },
            {
                new: true,
                runValidators: true,
                select: '-__v'
            }
        );

        if (!updatedUser) {
            return res.status(404).json({
                success: false,
                message: 'Kullanƒ±cƒ± bulunamadƒ±'
            });
        }

        res.json({
            success: true,
            message: 'Kullanƒ±cƒ± ba≈üarƒ±yla g√ºncellendi',
            data: updatedUser
        });

    } catch (error) {
        if (error.name === 'CastError') {
            return res.status(400).json({
                success: false,
                message: 'Ge√ßersiz kullanƒ±cƒ± ID formatƒ±'
            });
        }

        if (error.name === 'ValidationError') {
            const validationErrors = Object.values(error.errors).map(err => err.message);
            return res.status(400).json({
                success: false,
                message: 'Validation hatasƒ±',
                errors: validationErrors
            });
        }

        if (error.code === 11000) {
            return res.status(409).json({
                success: false,
                message: 'Bu email adresi zaten kullanƒ±lƒ±yor'
            });
        }

        res.status(500).json({
            success: false,
            message: 'Kullanƒ±cƒ± g√ºncellenirken hata olu≈ütu',
            error: error.message
        });
    }
});

// DELETE /api/users/:id
app.delete('/api/users/:id', async (req, res) => {
    try {
        const deletedUser = await User.findByIdAndDelete(req.params.id).select('-__v');

        if (!deletedUser) {
            return res.status(404).json({
                success: false,
                message: 'Kullanƒ±cƒ± bulunamadƒ±'
            });
        }

        res.json({
            success: true,
            message: 'Kullanƒ±cƒ± ba≈üarƒ±yla silindi',
            data: deletedUser
        });

    } catch (error) {
        if (error.name === 'CastError') {
            return res.status(400).json({
                success: false,
                message: 'Ge√ßersiz kullanƒ±cƒ± ID formatƒ±'
            });
        }

        res.status(500).json({
            success: false,
            message: 'Kullanƒ±cƒ± silinirken hata olu≈ütu',
            error: error.message
        });
    }
});

// GET /api/users/stats/summary
app.get('/api/users/stats/summary', async (req, res) => {
    try {
        const stats = await User.aggregate([
            {
                $group: {
                    _id: null,
                    totalUsers: { $sum: 1 },
                    averageAge: { $avg: '$age' },
                    minAge: { $min: '$age' },
                    maxAge: { $max: '$age' }
                }
            },
            {
                $project: {
                    _id: 0,
                    totalUsers: 1,
                    averageAge: { $round: ['$averageAge', 1] },
                    minAge: 1,
                    maxAge: 1
                }
            }
        ]);

        const statusStats = await User.aggregate([
            {
                $group: {
                    _id: '$status',
                    count: { $sum: 1 }
                }
            },
            {
                $sort: { count: -1 }
            }
        ]);

        const ageGroups = await User.aggregate([
            {
                $bucket: {
                    groupBy: '$age',
                    boundaries: [0, 18, 25, 35, 50, 65, 120],
                    default: 'Other',
                    output: {
                        count: { $sum: 1 },
                        users: { $push: '$name' }
                    }
                }
            }
        ]);

        res.json({
            success: true,
            data: {
                summary: stats[0] || { totalUsers: 0, averageAge: 0, minAge: 0, maxAge: 0 },
                statusDistribution: statusStats,
                ageGroups: ageGroups
            }
        });

    } catch (error) {
        res.status(500).json({
            success: false,
            message: 'ƒ∞statistikler getirilirken hata olu≈ütu',
            error: error.message
        });
    }
});

// GET /api/users/analytics/advanced
app.get('/api/users/analytics/advanced', async (req, res) => {
    try {
        const analytics = await User.aggregate([
            {
                $facet: {
                    overview: [
                        {
                            $group: {
                                _id: null,
                                totalUsers: { $sum: 1 },
                                avgAge: { $avg: '$age' },
                                minAge: { $min: '$age' },
                                maxAge: { $max: '$age' }
                            }
                        }
                    ],
                    emailDomains: [
                        {
                            $project: {
                                domain: {
                                    $arrayElemAt: [
                                        { $split: ['$email', '@'] },
                                        1
                                    ]
                                }
                            }
                        },
                        {
                            $group: {
                                _id: '$domain',
                                count: { $sum: 1 }
                            }
                        },
                        { $sort: { count: -1 } }
                    ],
                    ageCategories: [
                        {
                            $project: {
                                name: 1,
                                age: 1,
                                category: {
                                    $switch: {
                                        branches: [
                                            { case: { $lt: ['$age', 18] }, then: '√áocuk' },
                                            { case: { $lt: ['$age', 25] }, then: 'Gen√ß' },
                                            { case: { $lt: ['$age', 35] }, then: 'Yeti≈ükin' },
                                            { case: { $gte: ['$age', 35] }, then: 'Orta Ya≈ü+' }
                                        ],
                                        default: 'Diƒüer'
                                    }
                                }
                            }
                        },
                        {
                            $group: {
                                _id: '$category',
                                count: { $sum: 1 },
                                users: { $push: '$name' }
                            }
                        }
                    ]
                }
            }
        ]);

        res.json({
            success: true,
            data: analytics[0]
        });

    } catch (error) {
        res.status(500).json({
            success: false,
            message: 'Analitik veriler getirilirken hata olu≈ütu',
            error: error.message
        });
    }
});

// 404 Handler
app.use('*', (req, res) => {
    res.status(404).json({
        success: false,
        message: 'Bu endpoint mevcut deƒüil'
    });
});

// Global Error Handler
app.use((error, req, res, next) => {
    console.error('‚ùå Hata:', error);
    res.status(500).json({
        success: false,
        message: 'Sunucu hatasƒ± olu≈ütu',
        error: process.env.NODE_ENV === 'development' ? error.message : 'Internal server error'
    });
});

// Graceful shutdown
process.on('SIGINT', async () => {
    console.log('\nüîÑ Sunucu kapatƒ±lƒ±yor...');
    try {
        if (channel) {
            await channel.close();
            console.log('‚úÖ RabbitMQ channel kapatƒ±ldƒ±');
        }
        if (connection) {
            await connection.close();
            console.log('‚úÖ RabbitMQ baƒülantƒ±sƒ± kapatƒ±ldƒ±');
        }
    } catch (err) {
        console.error('‚ùå RabbitMQ kapatma hatasƒ±:', err.message);
    }
    try {
        await mongoose.connection.close();
        console.log('‚úÖ MongoDB baƒülantƒ±sƒ± kapatƒ±ldƒ±');
    } catch (err) {
        console.error('‚ùå MongoDB kapatma hatasƒ±:', err.message);
    }
    process.exit(0);
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`\nüöÄ Express.js + MongoDB + RabbitMQ sunucusu http://localhost:${PORT} adresinde √ßalƒ±≈üƒ±yor`);
    console.log('\nüìã Endpoint\'ler:');
    console.log('GET    http://localhost:3000/');
    console.log('POST   http://localhost:3000/api/users');
    console.log('\nüí° RabbitMQ UI: http://localhost:15672');
    console.log('üí° MongoDB UI: http://localhost:8081\n');
});